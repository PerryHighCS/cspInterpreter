<!DOCTYPE html>
<html>
    <head>
        <title>CSP GO!</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.41.0/codemirror.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.41.0/codemirror.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.41.0/addon/edit/matchbrackets.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.41.0/addon/comment/continuecomment.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.41.0/addon/comment/comment.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.41.0/addon/selection/mark-selection.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.41.0/mode/javascript/javascript.min.js"></script>
        <link rel="stylesheet" href="./cspInterp.css">

    </head>
    <body >
        <div class="container-fluid">
            <h2>cspInterpreter</h2>
            <div class="row">
                <div class="col">
                    <div class="clearfix">
                        <div class="btn-group float-right">
                            <span style="font-size: 30px;">üê¢
                            <input type="range" min="0" max="200" value="0" id="runSpeed" style="direction: rtl;">
                            üêá</span>
                            <button type="button" id="runButton" class="btn btn-primary">Run</button>
                            <button type="button" id="stepButton" class="btn btn-secondary">Step</button>
                            <button type="button" id="stopButton" class="btn btn-danger">Stop</button>
                        </div>
                    </div>
                    
                    <div style="border: 1px solid">
                        <textarea id="code" style="width: 100%; height: 600px; font-family: monospace">
# a test program
a <- [(10 MOD 3), (4 * 2 - 1)]
DISPLAY(a) // with comments!!
b <- a[1]
a[1] <- a[2]
a[2] <- b
DISPLAY(a) // with comments!!

FOR EACH num IN a {
    DISPLAY(num)
}

DISPLAY("How many times to repeat?")
times <- INPUT()

DISPLAY(times)
DISPLAY(go(times, right))
DISPLAY("DONE!\n")

PROCEDURE go(times, dir) {
    count <- 0
    REPEAT times / 2 TIMES {
        MOVE_FORWARD()
        IF (dir = right) {
            ROTATE_RIGHT()
        }
        ELSE {
            ROTATE_LEFT()
        }
        count <- count + 1
    }

    i <- 0
    REPEAT UNTIL (i >= times / 2) {
        MOVE_FORWARD()
        IF (NOT dir = right) {
            ROTATE_RIGHT()
        }
        ELSE {
            ROTATE_LEFT()
        }
        count <- count + 1
        i <- i + 1
    }

    DISPLAY(count)
    RETURN (count)
} 
                        </textarea>
                    </div>
                </div>
                <div class="col col-md-6">
                    <div class="row">
                        <div class="col">
                            <div>
                                <canvas id="worldDisplay" width="400" height="400" style="width: 400px; height: 400px; border: 1px solid"></canvas>                                
                            </div>
                            Output:
                            <pre id="consoleDisplay" style="width: 400px; height: 200px; overflow-y: auto; white-space: pre-wrap; background-color: lightgray;"></pre>
                        </div>
                        <div id="stackDisplay" class="col">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://code.jquery.com/jquery-3.2.1.min.js" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
        <script type="module">
import {cspInterpreter} from "./js/cspInterpreter.js"
import {zombieGraphics} from "./js/zGraphics.js"
import {RobotWorld} from "./js/robotWorld.js"

let source = document.getElementById("code");
let canvas = document.getElementById("worldDisplay");
let runbutton = document.getElementById("runButton");
let stopbutton = document.getElementById("stopButton");
let stepbutton = document.getElementById("stepButton");
let consoledisp = document.getElementById("consoleDisplay");
let stackdisp = document.getElementById("stackDisplay");
let runspeed = document.getElementById("runSpeed");

let height = $(source).height();
let editor = CodeMirror.fromTextArea(source, {
  lineNumbers: true,
  matchBrackets: true,
});

editor.setSize(null,height);

let world = new RobotWorld(canvas);

let interp = null;

function run(singleStep) {
    let code = editor.getValue();
    
    if (interp !== null) {
        if (interp.runMode() === 'run' || interp.runMode() === 'end') {
            interp.stop();
        }
        else {
            interp.continue();
            return false;
        }
    }
    
    clearMarks();
    
    $(runbutton).focus();
    
    interp = new cspInterpreter(code, [zombieGraphics], consoledisp, canvas,
                                stackdisp, editor);
                                
    interp.setSpeed(runspeed.value);
    interp.go(singleStep)
            .then(() => $(stopbutton).focus())
            .catch((e) => {alert(e); $(stopbutton).focus()});
    
    return false;
}

function stop() {
    if (interp !== null) {
        interp.stop();
    }
}

function step() {
    clearMarks();
    
    if (interp === null) {
        run(true);
    }
    else if (interp.runMode() === 'run' || interp.runMode() === 'step') {
        interp.step();
    }
    else {
        run(true);
    }
    
}

function setSpeed() {
    let minslider = 0;
    let maxslider = 100;
    let minspeed = Math.log(1);
    let maxspeed = Math.log(2000);
    
    let scale = (maxspeed-minspeed) / (maxslider-minslider) 
    
    if (zombie !== null) {
        interp.setSpeed(Math.exp(runspeed.value * scale + minspeed));
    }
}

runbutton.addEventListener('click', ()=>run(false));
stepbutton.addEventListener('click', step);
stopbutton.addEventListener('click', stop);
runspeed.addEventListener('input', setSpeed);

function clearMarks() {
    let marks = editor.getAllMarks();
    
    marks.forEach(mark => mark.clear());
}
        </script>

    </body>
</html>
